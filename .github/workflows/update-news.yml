name: Update Zen News Portal

on:
  schedule:
    # Uruchamia siÄ™ co 2 godziny
    - cron: '0 */2 * * *'
  workflow_dispatch: # MoÅ¼liwoÅ›Ä‡ rÄ™cznego uruchomienia
  push:
    branches: [ main ]
    paths: 
      - 'src/**'
      - 'package.json'

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci
        echo "Dependencies installed at $(date)" >> deployment.log
    
    - name: ğŸ“° Collect latest news
      run: |
        echo "Starting news collection at $(date)"
        node src/utils/newsCollector.js
        echo "News collection completed at $(date)" >> deployment.log
      continue-on-error: true
    
    - name: ğŸ—ï¸ Build React app
      run: |
        npm run build
        echo "Build completed at $(date)" >> deployment.log
        
        # Verify build output
        if [ ! -d "dist" ]; then
          echo "âŒ Build failed - no dist directory"
          exit 1
        fi
        
        echo "âœ… Build successful - $(du -sh dist | cut -f1) total size"
    
    - name: ğŸ“¤ Commit updated data
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add changes if any exist
        git add src/data/ deployment.log
        
        # Only commit if there are changes
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ¤– Auto-update: News & Art $(date '+%Y-%m-%d %H:%M UTC')"
          git push
          echo "Changes committed and pushed"
        fi
    
    - name: ğŸš€ Deploy to GitHub Pages
      uses: actions/deploy-pages@v3
      with:
        artifact_name: github-pages
        
    - name: ğŸ“Š Upload build artifacts
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist
        
    - name: ğŸ” Deployment Summary
      run: |
        echo "## ğŸŒŸ Zen Info Portal Deployment" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** âœ… Successful" >> $GITHUB_STEP_SUMMARY
        echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Articles:** $(jq length src/data/articles.json 2>/dev/null || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
        echo "**Size:** $(du -sh dist 2>/dev/null | cut -f1 || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "src/data/articles.json" ]; then
          echo "### ğŸ“° Latest Articles" >> $GITHUB_STEP_SUMMARY
          jq -r '.[:3] | .[] | "- **\(.title)** (\(.source))"' src/data/articles.json >> $GITHUB_STEP_SUMMARY
        fi

  # Osobny job do monitorowania kondycji
  health-check:
    needs: update-and-deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ¥ Health Check
      run: |
        echo "Checking portal health..."
        
        # SprawdÅº czy strona odpowiada (po 2 minutach na propagacjÄ™)
        sleep 120
        
        SITE_URL="https://zen-info.pl"
        if curl -sSf "$SITE_URL" > /dev/null; then
          echo "âœ… Portal is responding correctly"
        else
          echo "âš ï¸ Portal health check failed"
          # Opcjonalnie wyÅ›lij notyfikacjÄ™
        fi
